{% extends "contabilidad/base_contabilidad.html" %}

{% block title %}Crear Nueva Factura - Tesorero{% endblock %}
{% block page_title %}üìÑ Crear Nueva Factura{% endblock %}

{% block sidebar %}
<li class="nav-item">
    <a class="nav-link" href="{% url 'contabilidad:asistente_dashboard' %}">
        <i class="bi bi-speedometer2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'contabilidad:factura_cliente_list' %}">
        <i class="bi bi-receipt"></i> Mis Facturas
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{% url 'contabilidad:factura_cliente_crear' %}">
        <i class="bi bi-plus-circle"></i> Nueva Factura
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'contabilidad:reportes_contables' %}">
        <i class="bi bi-graph-up"></i> Reportes
    </a>
</li>
{% endblock %}

{% block header_buttons %}
<div class="btn-group me-2">
    <a href="{% url 'contabilidad:factura_cliente_list' %}" class="btn btn-sm btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver a Lista
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>üìÑ Crear Nueva Factura de Cliente</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="facturaForm">
                    {% csrf_token %}
                    
                    <!-- URL AJAX escondida para JavaScript -->
                    <input type="hidden" id="ajax_url" value="{% url 'contabilidad:factura_cliente_parse_pdf' %}">
                    
                    <!-- CAMPO PDF/IMAGEN CON AJAX REAL -->
                    <div class="mb-3">
                        <label class="form-label">üì§ Subir PDF o Imagen de Factura</label>
                        <input type="file" 
                               name="invoice_file" 
                               id="invoice_file_input" 
                               class="form-control" 
                               accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.webp">
                        <small class="text-muted">
                            El sistema leer√° los datos autom√°ticamente al seleccionar el archivo.
                        </small>
                        
                        <!-- Indicador de carga -->
                        <div id="pdf_loading" class="mt-2" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                            <span class="ms-2">Analizando archivo...</span>
                        </div>
                        
                        <!-- Mensajes -->
                        <div id="pdf_message" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Proyecto *</label>
                        <select name="project" id="project_select" class="form-select bg-dark text-white border-primary" required>
                            <option value="">Seleccione un proyecto...</option>
                            {% for proyecto in proyectos %}
                                <option value="{{ proyecto.cod_projects_id }}">
                                    {{ proyecto.cod_projects_id }} - {{ proyecto.cod_projects.dres_chance }} ({{ proyecto.state_projects }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">N√∫mero de Factura *</label>
                            <input type="text" 
                                   name="invoice_number" 
                                   id="invoice_number" 
                                   class="form-control" 
                                   required 
                                   value="{{ pdf_data.invoice_number|default:'' }}"
                                   placeholder="Ej: F001-00000384">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Monto (S/) *</label>
                            <input type="number" 
                                   name="amount" 
                                   id="amount" 
                                   class="form-control" 
                                   step="0.01" 
                                   required 
                                   value="{{ pdf_data.amount|default:'' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Emisi√≥n *</label>
                            <input type="date" 
                                   name="invoice_date" 
                                   id="invoice_date" 
                                   class="form-control" 
                                   required
                                   value="{{ pdf_data.invoice_date|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Vencimiento</label>
                            <input type="date" 
                                   name="due_date" 
                                   id="due_date" 
                                   class="form-control"
                                   value="{{ pdf_data.due_date|default:'' }}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea name="description" 
                                  id="description" 
                                  class="form-control" 
                                  rows="3" 
                                  placeholder="Descripci√≥n de los servicios facturados..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'contabilidad:factura_cliente_list' %}" class="btn btn-secondary">
                            ‚Üê Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            ‚úÖ Crear Factura (Estado: EMITIDA)
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üöÄ Script de PDF cargado');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM cargado');
    
    const fileInput = document.getElementById('invoice_file_input');
    const loadingDiv = document.getElementById('pdf_loading');
    const messageDiv = document.getElementById('pdf_message');
    const ajaxUrl = document.getElementById('ajax_url').value; // ‚úÖ LEER URL DEL INPUT HIDDEN
    
    // Campos del formulario
    const invoiceNumberInput = document.getElementById('invoice_number');
    const amountInput = document.getElementById('amount');
    const invoiceDateInput = document.getElementById('invoice_date');
    const dueDateInput = document.getElementById('due_date');
    
    console.log('üîç URL AJAX:', ajaxUrl);
    console.log('üîç Elementos encontrados:', {
        fileInput: !!fileInput,
        ajaxUrl: ajaxUrl
    });
    
    if (!fileInput) {
        console.error('‚ùå No se encontr√≥ el input de archivo');
        return;
    }
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            console.log('‚ö†Ô∏è No se seleccion√≥ archivo');
            return;
        }
        
        console.log('üìÑ Archivo seleccionado:', file.name, 'Tama√±o:', file.size, 'bytes');
        
        // Validar extensi√≥n
        const fileExt = file.name.toLowerCase().split('.').pop();
        const allowedExts = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp'];
        
        if (!allowedExts.includes(fileExt)) {
            console.warn('‚ö†Ô∏è Extensi√≥n no v√°lida:', fileExt);
            messageDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Por favor selecciona un PDF o imagen v√°lida</div>';
            return;
        }
        
        // Mostrar indicador de carga
        loadingDiv.style.display = 'block';
        messageDiv.innerHTML = '';
        console.log('üîÑ Iniciando procesamiento AJAX a:', ajaxUrl);
        
        // Crear FormData
        const formData = new FormData();
        formData.append('invoice_file', file);
        
        // Obtener CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('üîê CSRF Token obtenido:', csrftoken ? 'S√≠' : 'No');
        
        // Enviar AJAX
        fetch(ajaxUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('üì° Respuesta recibida. Status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Datos recibidos:', data);
            loadingDiv.style.display = 'none';
            
            if (data.success && data.data) {
                console.log('‚úÖ Procesamiento exitoso');
                let camposLlenados = 0;
                
                // Llenar campos autom√°ticamente
                if (data.data.invoice_number && !invoiceNumberInput.value) {
                    invoiceNumberInput.value = data.data.invoice_number;
                    console.log('‚úì N√∫mero de factura:', data.data.invoice_number);
                    camposLlenados++;
                }
                
                if (data.data.amount && !amountInput.value) {
                    amountInput.value = data.data.amount;
                    console.log('‚úì Monto:', data.data.amount);
                    camposLlenados++;
                }
                
                if (data.data.invoice_date && !invoiceDateInput.value) {
                    invoiceDateInput.value = data.data.invoice_date;
                    console.log('‚úì Fecha de emisi√≥n:', data.data.invoice_date);
                    camposLlenados++;
                }
                
                if (data.data.due_date && !dueDateInput.value) {
                    dueDateInput.value = data.data.due_date;
                    console.log('‚úì Fecha de vencimiento:', data.data.due_date);
                    camposLlenados++;
                }
                
                // Mensaje de √©xito
                messageDiv.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>‚úÖ ¬°√âxito!</strong> Se detectaron y llenaron ${camposLlenados} campos autom√°ticamente.
                        <br><small>Revisa los datos y modifica si es necesario.</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Resaltar campos llenados
                [invoiceNumberInput, amountInput, invoiceDateInput, dueDateInput].forEach(input => {
                    if (input && input.value) {
                        input.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 2000);
                    }
                });
                
            } else {
                console.warn('‚ö†Ô∏è No se detectaron datos:', data.message);
                messageDiv.innerHTML = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>‚ö†Ô∏è Atenci√≥n:</strong> ${data.message || 'No se pudieron detectar datos del archivo.'}
                        <br><small>Llena los campos manualmente.</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('‚ùå Error en AJAX:', error);
            loadingDiv.style.display = 'none';
            messageDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>‚ùå Error:</strong> No se pudo procesar el archivo.
                    <br><small>${error.message}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        });
    });
    
    console.log('‚úÖ Event listener configurado correctamente');
});
</script>
{% endblock %}