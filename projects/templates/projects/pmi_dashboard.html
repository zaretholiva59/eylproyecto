{% extends "base.html" %}

{% block title %}Dashboard PMI - {{ project.cod_projects_id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Dashboard PMI: {{ project.cod_projects_id }} - {{ project.cod_projects.dres_chance }}</h1>
    
    <!-- Resumen del Proyecto -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Resumen del Proyecto</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Cliente:</strong> {{ project.cod_projects.client_name }}</p>
                    <p><strong>C√≥digo:</strong> {{ project.cod_projects_id }}</p>
                    <p><strong>Fecha Inicio:</strong> {{ project.start_date|date:"d/m/Y" }}</p>
                    <p><strong>Centro de Costo:</strong> {{ project.cost_center }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Estado:</strong> {{ project.state_projects }}</p>
                    <p><strong>Duraci√≥n Estimada:</strong> {{ project.estimated_duration }} meses</p>
                    <p><strong>Avance F√≠sico:</strong> {{ pmi_metrics.physical_progress|floatformat:1 }}%</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Indicadores PMI -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Indicadores PMI - Earned Value Management</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center mb-3">
                                <div class="card-header">CPI (Eficiencia Costos)</div>
                                <div class="card-body">
                                    <h3 class="{% if pmi_metrics.cpi >= 1.0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ pmi_metrics.cpi|floatformat:3 }}
                                    </h3>
                                    <small>{% if pmi_metrics.cpi >= 1.0 %}‚úÖ Eficiente{% else %}‚ö†Ô∏è Sobre costos{% endif %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center mb-3">
                                <div class="card-header">SPI (Eficiencia Tiempo)</div>
                                <div class="card-body">
                                    <h3 class="{% if pmi_metrics.spi >= 1.0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ pmi_metrics.spi|floatformat:3 }}
                                    </h3>
                                    <small>{% if pmi_metrics.spi >= 1.0 %}‚úÖ En plazo{% else %}‚ö†Ô∏è Atrasado{% endif %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center mb-3">
                                <div class="card-header">EAC (Costo al finalizar)</div>
                                <div class="card-body">
                                    <h3>{{ pmi_metrics.eac|floatformat:0 }}</h3>
                                    <small>Estimaci√≥n de costo final</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center mb-3">
                                <div class="card-header">Avance F√≠sico</div>
                                <div class="card-body">
                                    <h3>{{ pmi_metrics.physical_progress|floatformat:1 }}%</h3>
                                    <small>Por actividades PMI</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©tricas financieras -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">M√©tricas Financieras</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p><strong>Facturaci√≥n:</strong> {{ financial_metrics.total_billed|default:"0" }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Cobranza:</strong> {{ financial_metrics.total_collected|default:"0" }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Progreso Financiero:</strong> {{ financial_metrics.financial_progress|default:0|floatformat:1 }}%</p>
                                        </div>
                                    </div>
                                    <small>F√≠sico: {{ pmi_metrics.physical_progress|floatformat:1 }}% | Financiero: {{ financial_metrics.financial_progress|default:0|floatformat:1 }}%</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Salud del proyecto -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card text-center mb-3 border-{% if performance_analysis.overall_health == '‚úÖ Saludable' %}success{% elif performance_analysis.overall_health == '‚ö†Ô∏è En observaci√≥n' %}warning{% else %}danger{% endif %}">
                                <div class="card-header">Salud General del Proyecto</div>
                                <div class="card-body">
                                    <h4>{{ performance_analysis.overall_health }}</h4>
                                    <small>Estado integral</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detalle de Avance F√≠sico - ACTIVIDADES PMI -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detalle de Avance F√≠sico - Actividades PMI</h5>
                    <a href="{% url 'pmi_activity_management' project.cod_projects_id %}" class="btn btn-light btn-sm">
                        üéØ Gestionar Actividades
                    </a>
                </div>
                <div class="card-body">
                    {% if physical_detail.activities %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Actividad</th>
                                    <th>Unidades</th>
                                    <th>Peso</th>
                                    <th>Progreso</th>
                                    <th>Contribuci√≥n</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in physical_detail.activities %}
                                <tr>
                                    <td>
                                        <strong>{{ activity.name }}</strong>
                                        <br><small class="text-muted">{{ activity.unit_of_measure }}</small>
                                    </td>
                                    <td>
                                        <small>{{ activity.completed_units }}/{{ activity.total_units }}</small>
                                    </td>
                                    <td>{{ activity.weight|floatformat:1 }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" role="progressbar" style="width: {{ activity.percentage_completed }}%;"
                                                aria-valuenow="{{ activity.percentage_completed }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ activity.percentage_completed|floatformat:1 }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ activity.contribution|floatformat:2 }}%</td>
                                    <td>
                                        {% if activity.percentage_completed >= 100 %}
                                            <span class="badge bg-success">Completada</span>
                                        {% elif activity.percentage_completed > 0 %}
                                            <span class="badge bg-warning">En progreso</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pendiente</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Avance Total</strong></td>
                                    <td colspan="2" class="text-end">
                                        <strong>{{ physical_detail.total_physical_progress|floatformat:2 }}%</strong>
                                    </td>
                                    <td>
                                        {% if physical_detail.weights_valid %}
                                        <span class="badge bg-success">Pesos V√°lidos</span>
                                        {% else %}
                                        <span class="badge bg-danger">Pesos Invalidos</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No hay actividades PMI configuradas</p>
                        <a href="{% url 'pmi_activity_management' project.cod_projects_id %}" class="btn btn-primary">
                            üéØ Configurar Actividades PMI
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- PMI Compliance Indicator -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="alert {% if pmi_metrics.pmi_compliant %}alert-success{% else %}alert-warning{% endif %}">
                <h5 class="alert-heading">
                    {% if pmi_metrics.pmi_compliant %}
                    ‚úÖ SISTEMA PMI COMPLIANT
                    {% else %}
                    ‚ö†Ô∏è SISTEMA NO PMI COMPLIANT
                    {% endif %}
                </h5>
                <p class="mb-0">
                    {% if pmi_metrics.pmi_compliant %}
                    El proyecto est√° siendo monitoreado bajo est√°ndares PMI para Earned Value Management.
                    {% else %}
                    Se requiere configuraci√≥n adicional para cumplir con est√°ndares PMI.
                    {% endif %}
                    | <strong>Avance calculado desde actividades reales</strong>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}