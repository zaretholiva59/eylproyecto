{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary">Curva S - {{ proyecto.cod_projects_id }} - {{ proyecto.cod_projects.dres_chance }}</h2>
        <a href="/projects/grid/grid-costos/{{ proyecto.cod_projects_id }}/" class="btn btn-outline-secondary">
            ‚Üê Volver a Costos
        </a>
    </div>

<div class="row">
    <!-- GR√ÅFICO 1: CURVA S -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìä Curva S - An√°lisis EVM</h5>
                <div class="d-flex align-items-center gap-2">
                    <div class="input-group input-group-sm" style="width: 170px;">
                        <span class="input-group-text">Escala (S/)</span>
                        <select id="curvaSScaleSelector" class="form-select form-select-sm" onchange="setMontoScaleCurvaS(this.value)">
                            <option value="auto" selected>Auto</option>
                            <option value="5000">5k</option>
                            <option value="10000">10k</option>
                            <option value="20000">20k</option>
                            <option value="50000">50k</option>
                            <option value="100000">100k</option>
                            <option value="200000">200k</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <span class="input-group-text">Min (S/)</span>
                        <select id="curvaSMinSelector" class="form-select form-select-sm" onchange="setMontoMinCurvaS(this.value)">
                            <option value="auto" selected>Auto</option>
                            <option value="0">0</option>
                            <option value="5000">5k</option>
                            <option value="10000">10k</option>
                            <option value="20000">20k</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <span class="input-group-text">Periodo</span>
                        <select id="curvaSPeriodoMinSelector" class="form-select form-select-sm" onchange="applyPeriodoMinCurvaS(this.value)">
                            <option value="auto" selected>Auto</option>
                            <option value="3">√öltimos 3</option>
                            <option value="6">√öltimos 6</option>
                            <option value="12">√öltimos 12</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 260px;">
                        <span class="input-group-text">Rango</span>
                        <select id="curvaSRangoDesde" class="form-select form-select-sm" style="width: 120px;"></select>
                        <select id="curvaSRangoHasta" class="form-select form-select-sm" style="width: 120px;" onchange="applyPeriodoRangoCurvaS()"></select>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light active" onclick="showCurvaSView('evm', event)">üìà EVM</button>
                        <button class="btn btn-outline-light" onclick="showCurvaSView('cpi', event)">üìä CPI/SPI</button>
                        <button class="btn btn-outline-light" onclick="showCurvaSView('progreso', event)">üìÖ Progreso</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- VISTA EVM TABLA -->
                <div id="curvaS-evm" class="chart-view">
                    <canvas id="curvaSChart" height="200"></canvas>
                    <div class="mt-3" id="tablaEVMContainer">
                        <!-- Tabla EVM se cargar√° aqu√≠ -->
                    </div>
                </div>
                
                <!-- VISTA CPI/SPI -->
                <div id="curvaS-cpi" class="chart-view" style="display: none;">
                    <canvas id="cpiSpiChart" height="200"></canvas>
                </div>
                
                <!-- VISTA PROGRESO -->
                <div id="curvaS-progreso" class="chart-view" style="display: none;">
                    <canvas id="progresoChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- GR√ÅFICO 2: GR√ÅFICO EJECUTIVO -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìà Gr√°fico Ejecutivo</h5>
                <div class="d-flex align-items-center gap-2">
                    <div class="input-group input-group-sm" style="width: 170px;">
                        <span class="input-group-text">Escala (S/)</span>
                        <select id="excelScaleSelector" class="form-select form-select-sm" onchange="setMontoScaleExecutive(this.value)">
                            <option value="auto" selected>Auto</option>
                            <option value="5000">5k</option>
                            <option value="10000">10k</option>
                            <option value="20000">20k</option>
                            <option value="50000">50k</option>
                            <option value="100000">100k</option>
                            <option value="200000">200k</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <span class="input-group-text">Min (S/)</span>
                        <select id="execMinSelector" class="form-select form-select-sm" onchange="setMontoMinExecutive(this.value)">
                            <option value="auto" selected>Auto</option>
                            <option value="0">0</option>
                            <option value="5000">5k</option>
                            <option value="10000">10k</option>
                            <option value="20000">20k</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <span class="input-group-text">Periodo</span>
                        <select id="execPeriodoMinSelector" class="form-select form-select-sm" onchange="applyPeriodoMinExecutive(this.value)">
                            <option value="auto" selected>Auto</option>
                            <option value="3">√öltimos 3</option>
                            <option value="6">√öltimos 6</option>
                            <option value="12">√öltimos 12</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 300px;">
                        <span class="input-group-text">Rango</span>
                        <select id="execRangoDesde" class="form-select form-select-sm" style="width: 140px;"></select>
                        <select id="execRangoHasta" class="form-select form-select-sm" style="width: 140px;" onchange="applyPeriodoRangoExecutive()"></select>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light active" onclick="showExcelView('avance', event)">üöÄ Avance</button>
                        <button class="btn btn-outline-light" onclick="showExcelView('costos', event)">üì¶ Costos</button>
                        <button class="btn btn-outline-light" onclick="showExcelView('eficiencia', event)">üìà Eficiencia</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- VISTA AVANCE (reemplaza BAC) -->
                <div id="excel-avance" class="chart-view">
                    <canvas id="avanceChart" height="200"></canvas>
                </div>
                
                <!-- VISTA DISTRIBUCI√ìN COSTOS -->
                <div id="excel-costos" class="chart-view" style="display: none;">
                    <canvas id="costosChart" height="200"></canvas>
                </div>
                
                <!-- VISTA EFICIENCIA -->
                <div id="excel-eficiencia" class="chart-view" style="display: none;">
                    <canvas id="eficienciaChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ìN INFORMACI√ìN (se mantiene igual) -->
<div class="row">
    <div class="col-md-4">
        <!-- Informaci√≥n del Proyecto -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Informaci√≥n del Proyecto</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>Centro Costo:</strong> {{ proyecto.cost_center }}</p>
                <p class="mb-2"><strong>BAC:</strong> S/ {{ bac_display }}</p>
                <p class="mb-1"><strong>Duraci√≥n Planeada:</strong> {{ duracion_planeada }} meses</p>
                <p class="mb-0"><strong>Duraci√≥n Real:</strong> {{ duracion_real }} meses</p>
            </div>
        </div>

        <!-- Resumen Ejecutivo -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">üìä Resumen Ejecutivo</h6>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Estado:</strong>
                    <span class="badge {% if estado_proyecto == 'COMPLETADO' %}bg-success{% else %}bg-warning{% endif %}">
                        {{ estado_proyecto }}
                    </span>
                </p>
                <p class="mb-1"><strong>Ejecuci√≥n Presupuestal:</strong> {{ porcentaje_ejecutado|floatformat:1 }}%</p>
                <p class="mb-1"><strong>Monto Ejecutado:</strong> S/ {{ bac_display }}</p>
                <p class="mb-0"><strong>Monto Faltante:</strong> S/ {{ monto_faltante|floatformat:2 }}</p>
            </div>
        </div>

        <!-- M√©tricas de Valor Ganado -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">M√©tricas de Valor Ganado</h6>
            </div>
            <div class="card-body">
                <div class="mb-2"><strong>BAC Planeado:</strong> S/ {{ bac_planeado_display }}</div>
                <div class="mb-2"><strong>BAC Real:</strong> S/ {{ bac_display }}</div>
                <div class="mb-2"><strong>CPI:</strong> {{ cpi|floatformat:2 }}</div>
                <div class="mb-2"><strong>SPI:</strong> {{ spi|floatformat:2 }}</div>
                <div class="mb-2"><strong>CV:</strong> S/ {{ cv|floatformat:2 }}</div>
                <div class="mb-2"><strong>SV:</strong> S/ {{ sv|floatformat:2 }}</div>
                <div class="mb-2"><strong>EAC:</strong> S/ {{ eac|floatformat:2 }}</div>
                <div class="mb-0"><strong>ETC:</strong> S/ {{ etc|floatformat:2 }}</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Inyectar datos del backend en variables globales para los gr√°ficos
window.dashboardData = {
    meses: {{ meses|default:"[]"|safe }},
    pv: {{ pv|default:"[]"|safe }},
    ev: {{ ev|default:"[]"|safe }},
    ac: {{ ac|default:"[]"|safe }},
    ac_paid: {{ ac_paid|default:"[]"|safe }},
    cpi: {{ cpi_series|default:"[]"|safe }},
    spi: {{ spi_series|default:"[]"|safe }},
    bac: {{ bac|default:0 }}
};
window.facturacionMensual = {{ facturacion_mensual|default:"[]"|safe }};
window.bacPlaneado = {{ bac_planeado|default:0 }};
window.bacReal = {{ bac|default:0 }};
// Funciones para cambiar vistas
function showCurvaSView(view, event) {
    // Ocultar todas las vistas de Curva S
    document.querySelectorAll('#curvaS-evm, #curvaS-cpi, #curvaS-progreso').forEach(el => {
        el.style.display = 'none';
    });
    // Mostrar vista seleccionada
    document.getElementById(`curvaS-${view}`).style.display = 'block';
    
    // Actualizar botones activos de forma segura
    if (event && event.target) {
        const group = event.target.closest('.btn-group');
        if (group) {
            group.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
    }
}

function showExcelView(view, event) {
    // Ocultar todas las vistas de Excel
    document.querySelectorAll('#excel-avance, #excel-costos, #excel-eficiencia').forEach(el => {
        el.style.display = 'none';
    });
    // Mostrar vista seleccionada
    document.getElementById(`excel-${view}`).style.display = 'block';
    
    // Actualizar botones activos de forma segura
    if (event && event.target) {
        const group = event.target.closest('.btn-group');
        if (group) {
            group.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
    }
}

// Inicializar gr√°ficos cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    try {
        // Curva S con fallbacks para evitar l√≠neas planas
        const ctxCurvaS = document.getElementById('curvaSChart');
        if (ctxCurvaS) {
            const d = window.dashboardData || {};
            const labels = Array.isArray(d.meses) ? d.meses : [];
            let pv = (d.pv || []).map(x => Number(x || 0));
            let ev = (d.ev || []).map(x => Number(x || 0));
            const ac = (d.ac || []).map(x => Number(x || 0));
            const acPaid = (d.ac_paid || []).map(x => Number(x || 0));

            const n = labels.length;
            if (n > 0) {
                // Si hay menos de 2 puntos, generar etiquetas y rampas para evitar solo puntos
                if (n < 2) {
                    let fbLabels = [];
                    if (Array.isArray(d.meses) && d.meses.length) {
                        fbLabels = (d.meses.slice(0, 3)).map(m => String(m).startsWith('Mes') ? String(m) : 'Mes ' + String(m));
                    } else {
                        fbLabels = ['Mes 1', 'Mes 2', 'Mes 3'];
                    }
                    const ramp = (total, count) => Array.from({length: count}, (_, i) => Number(((total * i) / (count - 1)).toFixed(2)));
                    const lastPV = pv.length ? pv[pv.length - 1] : 0;
                    const lastEV = ev.length ? ev[ev.length - 1] : 0;
                    const lastAC = ac.length ? ac[ac.length - 1] : 0;
                    const lastPaid = acPaid.length ? acPaid[acPaid.length - 1] : 0;
                    labels.splice(0, labels.length, ...fbLabels);
                    pv = ramp(lastPV, fbLabels.length);
                    ev = ramp(lastEV, fbLabels.length);
                    // Si EV queda todo en 0, usa PV
                    if (ev.every(v => Math.abs(v) < 1e-6)) ev = pv.slice();
                    const acRamp = ramp(lastAC, fbLabels.length);
                    ac.splice(0, ac.length, ...acRamp);
                    const paidRamp = ramp(lastPaid, fbLabels.length);
                    acPaid.splice(0, acPaid.length, ...paidRamp);
                }
                const pvMax = pv.length ? Math.max(...pv) : 0;
                const pvAllZero = pv.length && pv.every(v => Math.abs(v) < 1e-6);
                if (!pv.length || pvAllZero || pvMax < 1e-3) {
                    let bacRef = Number(window.bacPlaneado || window.bacReal || d.bac || 0);
                    if (!bacRef || bacRef < 1e-6) {
                        bacRef = ac.length ? Math.max(...ac) : 0;
                    }
                    const nn = labels.length || n || 1;
                    pv = Array.from({length: nn}, (_, i) => Number(((bacRef * (i+1)) / nn).toFixed(2)));
                }
                const uniqueEV = Array.from(new Set(ev.map(v => Number(v.toFixed(2)))));
                const evAllZero = ev.length && ev.every(v => Math.abs(v) < 1e-6);
                if (!ev.length || evAllZero || uniqueEV.length <= 1) {
                    let target = ev.length ? ev[ev.length - 1] : 0;
                    if (!target || target < 1e-6) {
                        target = ac.length ? Math.max(...ac) : 0;
                    }
                    const nn = labels.length || n || 1;
                    ev = Array.from({length: nn}, (_, i) => Number(((target * (i+1)) / nn).toFixed(2)));
                }
                // Si a√∫n est√° plana, usar PV como aproximaci√≥n de visualizaci√≥n
                if (ev.every(v => Math.abs(v) < 1e-6)) {
                    ev = pv.slice();
                }

                // Guardar datos originales para filtros
                window._origCurvaS = {
                    labels: labels.slice(),
                    pv: pv.slice(),
                    ev: ev.slice(),
                    ac: ac.slice(),
                    ac_paid: acPaid.slice()
                };
                window.curvaSChartInst = new Chart(ctxCurvaS, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'PV - Valor Planeado', data: pv, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', borderWidth: 2, pointRadius: 2, fill: true, tension: 0.4 },
                            { label: 'EV - Valor Ganado', data: ev, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', borderWidth: 2, pointRadius: 2, fill: true, tension: 0.4 },
                            { label: 'AC - Costo Real', data: ac, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', borderWidth: 2, pointRadius: 2, fill: true, tension: 0.4 },
                            { label: 'Cobros Verificados (Cliente)', data: acPaid, borderColor: '#6f42c1', backgroundColor: 'rgba(111,66,193,0.1)', borderWidth: 2, pointRadius: 2, fill: true, tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { title: { display: true, text: 'Curva S - An√°lisis de Valor Ganado' }, tooltip: { mode: 'index', intersect: false } },
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'Monto (S/)' }, suggestedMax: undefined, max: undefined }, x: { title: { display: true, text: 'Meses' } } }
                    }
                });
            }
        }

        // Gr√°fico Avance (acumulado) basado en GRID
        const ctxAvance = document.getElementById('avanceChart');
        if (ctxAvance) {
            const fm = window.facturacionMensual || [];
            let labelsAv = fm.map(x => x.mes);
            const factMensual = fm.map(x => Number(x.total || 0));
            const factAcum = [];
            let accF = 0;
            for (let i = 0; i < factMensual.length; i++) { accF += factMensual[i]; factAcum.push(Number(accF.toFixed(2))); }
            let acAcum = (window.dashboardData && window.dashboardData.ac) ? window.dashboardData.ac.map(x => Number(x||0)) : [];
            if (labelsAv.length && acAcum.length > labelsAv.length) acAcum = acAcum.slice(0, labelsAv.length);
            const bacReal = Number(window.bacReal || 0);
            const avancePct = [];
            for (let j = 0; j < factAcum.length; j++) {
                const pct = (bacReal && bacReal > 0) ? (factAcum[j] / bacReal) * 100 : (acAcum[j] ? (factAcum[j] / acAcum[j]) * 100 : 0);
                avancePct.push(Number(pct.toFixed(1)));
            }
            if (!labelsAv.length || labelsAv.length < 2) {
                const d = window.dashboardData || {};
                // Construir al menos 3 etiquetas para asegurar l√≠neas
                let fbCount = 3;
                if (Array.isArray(d.meses) && d.meses.length >= 3) fbCount = 3;
                else if (Array.isArray(d.meses) && d.meses.length > 0) fbCount = Math.min(3, d.meses.length);
                let fbLabels = [];
                if (Array.isArray(d.meses) && d.meses.length) {
                    fbLabels = d.meses.slice(0, fbCount).map(m => {
                        const s = String(m);
                        return s.match(/\d{4}/) ? s : (s.startsWith('Mes') ? s : 'Mes ' + s);
                    });
                } else {
                    fbLabels = Array.from({length: fbCount}, (_, k) => 'Mes ' + (k + 1));
                }

                // Valores finales disponibles
                const lastFact = factAcum.length ? factAcum[factAcum.length - 1] : (factMensual.length ? factMensual[factMensual.length - 1] : 0);
                const lastAC = (acAcum.length ? acAcum[Math.min(acAcum.length - 1, (labelsAv.length ? labelsAv.length - 1 : 0))] : ((d.ac && d.ac.length) ? d.ac[d.ac.length - 1] : 0));

                // Rampas para visualizar l√≠neas (de 0 al total)
                const ramp = (total, n) => Array.from({length: n}, (_, ri) => Number(((total * ri) / (n - 1)).toFixed(2)));
                const factAcumFb = ramp(lastFact, fbLabels.length);
                let acAcumFb = [];
                if (acAcum.length >= fbLabels.length) acAcumFb = acAcum.slice(0, fbLabels.length);
                else if (d.ac && d.ac.length) acAcumFb = d.ac.slice(0, fbLabels.length).map(x => Number(x || 0));
                else acAcumFb = ramp(lastAC, fbLabels.length);

                const bac = bacReal && bacReal > 0 ? bacReal : (acAcumFb.length ? acAcumFb[acAcumFb.length - 1] : lastAC);
                const avancePctFb = factAcumFb.map((fv, idx) => {
                    const acv = acAcumFb[idx] || 0;
                    const pct = bac > 0 ? (fv / bac) * 100 : (acv > 0 ? (fv / acv) * 100 : 0);
                    return Number(pct.toFixed(1));
                });

                labelsAv = fbLabels;
                // Reemplazar arrays con fallback para asegurar l√≠neas
                factAcum.length = 0; factAcum.push(...factAcumFb);
                acAcum = acAcumFb;
                // Sobrescribir avancePct
                while (avancePct.length) avancePct.pop();
                Array.prototype.push.apply(avancePct, avancePctFb);
            }
            // Guardar datos originales para filtros ejecutivos
            window._origExec = {
                labels: labelsAv.slice(),
                factAcum: factAcum.slice(),
                acAcum: acAcum.slice(),
                avancePct: avancePct.slice(),
                factMensual: factMensual.slice()
            };
            window.avanceChartInst = new Chart(ctxAvance, {
                type: 'line',
                data: {
                    labels: labelsAv,
                    datasets: [
                        { label: 'Facturaci√≥n acumulada (GRID)', data: factAcum, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2 },
                        { label: 'Costos acumulados (AC)', data: acAcum, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2 },
                        { label: 'Avance (%)', data: avancePct, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', fill: false, tension: 0.3, yAxisID: 'y1', borderWidth: 2, pointRadius: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Avance del Proyecto (Acumulado)' }, legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Monto (S/)' }, suggestedMax: undefined, max: undefined }, y1: { beginAtZero: true, position: 'right', title: { display: true, text: '% Avance' }, min: 0, max: 100 } }
                }
            });
        }

        // Gr√°fico Costos (Facturaci√≥n vs Costos mensual)
        const ctxCostos = document.getElementById('costosChart');
        if (ctxCostos) {
            const fm = window.facturacionMensual || [];
            let labels = fm.map(x => x.mes);
            let factValues = fm.map(x => Number(x.total || 0));
            const acSeries = (window.dashboardData && window.dashboardData.ac) ? window.dashboardData.ac.map(x => Number(x||0)) : [];
            const acDelta = [];
            for (let i = 0; i < acSeries.length; i++) {
                const prev = i > 0 ? acSeries[i-1] : 0;
                acDelta.push(acSeries[i] - prev);
            }
            let costValues = [];
            for (let j = 0; j < fm.length; j++) {
                costValues.push(Number(acDelta[j] || 0));
            }
            if (!labels.length || labels.length < 2) {
                const d = window.dashboardData || {};
                let fbLabels = (d.meses || []).map(m => 'Mes ' + m);
                if (!fbLabels.length) fbLabels = ['Mes 1','Mes 2','Mes 3'];
                const lastFact = factValues.length ? factValues[factValues.length - 1] : 0;
                const lastCost = costValues.length ? costValues[costValues.length - 1] : (acDelta.length ? acDelta[acDelta.length - 1] : 0);
                const ramp = (total, n) => Array.from({length: n}, (_, k) => Number(((total * k) / (n - 1)).toFixed(2)));
                labels = fbLabels.slice(0, Math.max(3, Math.min(3, fbLabels.length)));
                factValues = ramp(lastFact, labels.length);
                costValues = ramp(lastCost, labels.length);
            }
            window._origCostos = {
                labels: labels.slice(),
                factValues: factValues.slice(),
                costValues: costValues.slice()
            };
            window.costosChartInst = new Chart(ctxCostos, {
                type: 'bar',
                data: { labels: labels, datasets: [ { label: 'Facturaci√≥n (Cliente Verificada)', data: factValues, backgroundColor: 'rgba(25,135,84,0.7)' }, { label: 'Costos (AC mensual)', data: costValues, backgroundColor: 'rgba(220,53,69,0.7)' } ] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Facturaci√≥n vs Costos (Mensual - GRID)' }, legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true, suggestedMax: undefined, max: undefined } } }
            });
        }

        // Gr√°fico Eficiencia
        const ctxEficiencia = document.getElementById('eficienciaChart');
        if (ctxEficiencia) {
            const fm = window.facturacionMensual || [];
            let labels = fm.map(x => x.mes);
            const factValues = fm.map(x => Number(x.total || 0));
            const acSeries = (window.dashboardData && window.dashboardData.ac) ? window.dashboardData.ac.map(x => Number(x||0)) : [];
            const acDelta = [];
            for (let i = 0; i < acSeries.length; i++) {
                const prev = i > 0 ? acSeries[i-1] : 0;
                acDelta.push(acSeries[i] - prev);
            }
            let effValues = [];
            for (let j = 0; j < fm.length; j++) {
                const cost = Number(acDelta[j] || 0);
                const fact = Number(factValues[j] || 0);
                const eff = cost > 0 ? (fact / cost) * 100 : 100;
                effValues.push(Number(eff.toFixed(1)));
            }
            if (!labels.length || labels.length < 2) {
                const d = window.dashboardData || {};
                labels = (d.meses || []).map(m => 'Mes ' + m);
                if (!labels.length) labels = ['Mes 1','Mes 2','Mes 3'];
                // Simular eficiencia estable cuando no hay suficientes puntos
                const n = Math.max(3, Math.min(3, labels.length));
                labels = labels.slice(0, n);
                effValues = Array.from({length: n}, () => 100);
            }
            window._origEficiencia = { labels: labels.slice(), effValues: effValues.slice() };
            window.eficienciaChartInst = new Chart(ctxEficiencia, { type: 'line', data: { labels: labels, datasets: [ { label: 'Eficiencia Mensual (Facturaci√≥n/Costos)', data: effValues, borderColor: '#ff6384', backgroundColor: 'rgba(255,99,132,0.1)', fill: true, tension: 0.4 } ] }, options: { responsive: true, plugins: { title: { display: true, text: 'Tendencia de Eficiencia (GRID)' }, legend: { position: 'bottom' } }, scales: { y: { min: 0, max: 200 } } } });
        }
    } catch (err) {
        console.error('Error inicializando gr√°ficos:', err);
    }
}

// Filtros de escala de montos
function setMontoScaleCurvaS(val) {
    try {
        const chart = window.curvaSChartInst;
        if (!chart) return;
        if (val === 'auto') {
            chart.options.scales.y.max = undefined;
            chart.options.scales.y.suggestedMax = undefined;
        } else {
            const maxVal = Number(val);
            chart.options.scales.y.max = maxVal;
            chart.options.scales.y.suggestedMax = maxVal;
        }
        chart.update();
    } catch (e) { console.error('Error aplicando escala Curva S:', e); }
}

function setMontoScaleExecutive(val) {
    try {
        const charts = [window.avanceChartInst, window.costosChartInst];
        for (let i = 0; i < charts.length; i++) {
            const chart = charts[i];
            if (!chart) continue;
            if (val === 'auto') {
                chart.options.scales.y.max = undefined;
                chart.options.scales.y.suggestedMax = undefined;
            } else {
                const maxVal = Number(val);
                chart.options.scales.y.max = maxVal;
                chart.options.scales.y.suggestedMax = maxVal;
            }
            chart.update();
        }
    } catch (e) { console.error('Error aplicando escala Ejecutivo:', e); }
}

// M√≠nimos de eje Y
function setMontoMinCurvaS(val) {
    try {
        const chart = window.curvaSChartInst; if (!chart) return;
        chart.options.scales.y.min = (val === 'auto') ? undefined : Number(val);
        chart.update();
    } catch (e) { console.error('Error aplicando m√≠nimo Curva S:', e); }
}

function setMontoMinExecutive(val) {
    try {
        const charts = [window.avanceChartInst, window.costosChartInst];
        for (let i = 0; i < charts.length; i++) {
            const chart = charts[i]; if (!chart) continue;
            chart.options.scales.y.min = (val === 'auto') ? undefined : Number(val);
            chart.update();
        }
    } catch (e) { console.error('Error aplicando m√≠nimo Ejecutivo:', e); }
}

// --- Filtros de periodo ---
function applyPeriodoMinCurvaS(val){
    try {
        const orig = window._origCurvaS; const ch = window.curvaSChartInst; if (!orig || !ch) return;
        const n = orig.labels.length;
        const count = (val === 'auto') ? n : Math.max(1, Math.min(n, Number(val)));
        const start = Math.max(0, n - count);
        const labels = orig.labels.slice(start);
        ch.data.labels = labels;
        ch.data.datasets[0].data = orig.pv.slice(start);
        ch.data.datasets[1].data = orig.ev.slice(start);
        ch.data.datasets[2].data = orig.ac.slice(start);
        if (ch.data.datasets.length > 3) ch.data.datasets[3].data = orig.ac_paid.slice(start);
        populateCurvaSRango(labels);
        ch.update();
    } catch(e){ console.error('Error aplicando periodo m√≠nimo Curva S:', e); }
}

function applyPeriodoRangoCurvaS(){
    try {
        const orig = window._origCurvaS; const ch = window.curvaSChartInst; if (!orig || !ch) return;
        const dSel = document.getElementById('curvaSRangoDesde');
        const hSel = document.getElementById('curvaSRangoHasta');
        if (!dSel || !hSel) return;
        const li = orig.labels.indexOf(dSel.value);
        const hi = orig.labels.indexOf(hSel.value);
        if (li === -1 || hi === -1) return;
        const start = Math.min(li, hi), end = Math.max(li, hi) + 1;
        const labels = orig.labels.slice(start, end);
        ch.data.labels = labels;
        ch.data.datasets[0].data = orig.pv.slice(start, end);
        ch.data.datasets[1].data = orig.ev.slice(start, end);
        ch.data.datasets[2].data = orig.ac.slice(start, end);
        if (ch.data.datasets.length > 3) ch.data.datasets[3].data = orig.ac_paid.slice(start, end);
        ch.update();
    } catch(e){ console.error('Error aplicando rango Curva S:', e); }
}

function applyPeriodoMinExecutive(val){
    try {
        const o = window._origExec; if (!o) return;
        const n = o.labels.length; const count = (val === 'auto') ? n : Math.max(1, Math.min(n, Number(val)));
        const start = Math.max(0, n - count);
        const labels = o.labels.slice(start);
        if (window.avanceChartInst){
            const ch = window.avanceChartInst;
            ch.data.labels = labels;
            ch.data.datasets[0].data = o.factAcum.slice(start);
            ch.data.datasets[1].data = o.acAcum.slice(start);
            ch.data.datasets[2].data = o.avancePct.slice(start);
            ch.update();
        }
        if (window.costosChartInst){
            const oc = window._origCostos; const ch2 = window.costosChartInst;
            ch2.data.labels = oc.labels.slice(start);
            ch2.data.datasets[0].data = oc.factValues.slice(start);
            ch2.data.datasets[1].data = oc.costValues.slice(start);
            ch2.update();
        }
        if (window.eficienciaChartInst){
            const oe = window._origEficiencia; const ch3 = window.eficienciaChartInst;
            ch3.data.labels = oe.labels.slice(start);
            ch3.data.datasets[0].data = oe.effValues.slice(start);
            ch3.update();
        }
        populateExecRango(labels);
    } catch(e){ console.error('Error aplicando periodo m√≠nimo Ejecutivo:', e); }
}

function applyPeriodoRangoExecutive(){
    try {
        const o = window._origExec; if (!o) return;
        const dSel = document.getElementById('execRangoDesde');
        const hSel = document.getElementById('execRangoHasta');
        if (!dSel || !hSel) return;
        const li = o.labels.indexOf(dSel.value); const hi = o.labels.indexOf(hSel.value);
        if (li === -1 || hi === -1) return;
        const start = Math.min(li, hi), end = Math.max(li, hi) + 1;
        const labels = o.labels.slice(start, end);
        if (window.avanceChartInst){
            const ch = window.avanceChartInst;
            ch.data.labels = labels;
            ch.data.datasets[0].data = o.factAcum.slice(start, end);
            ch.data.datasets[1].data = o.acAcum.slice(start, end);
            ch.data.datasets[2].data = o.avancePct.slice(start, end);
            ch.update();
        }
        if (window.costosChartInst){
            const oc = window._origCostos; const ch2 = window.costosChartInst;
            ch2.data.labels = oc.labels.slice(start, end);
            ch2.data.datasets[0].data = oc.factValues.slice(start, end);
            ch2.data.datasets[1].data = oc.costValues.slice(start, end);
            ch2.update();
        }
        if (window.eficienciaChartInst){
            const oe = window._origEficiencia; const ch3 = window.eficienciaChartInst;
            ch3.data.labels = oe.labels.slice(start, end);
            ch3.data.datasets[0].data = oe.effValues.slice(start, end);
            ch3.update();
        }
    } catch(e){ console.error('Error aplicando rango Ejecutivo:', e); }
}

function populateCurvaSRango(labels){
    try {
        const dSel = document.getElementById('curvaSRangoDesde');
        const hSel = document.getElementById('curvaSRangoHasta');
        if (!dSel || !hSel) return;
        dSel.innerHTML = '';
        hSel.innerHTML = '';
        labels.forEach(function(l){
            const o1 = document.createElement('option'); o1.value = String(l); o1.textContent = String(l); dSel.appendChild(o1);
            const o2 = document.createElement('option'); o2.value = String(l); o2.textContent = String(l); hSel.appendChild(o2);
        });
        if (labels.length){ dSel.value = String(labels[0]); hSel.value = String(labels[labels.length-1]); }
    } catch(e){ console.error('Error poblando rango Curva S:', e); }
}

function populateExecRango(labels){
    try {
        const dSel = document.getElementById('execRangoDesde');
        const hSel = document.getElementById('execRangoHasta');
        if (!dSel || !hSel) return;
        dSel.innerHTML = '';
        hSel.innerHTML = '';
        labels.forEach(function(l){
            const o1 = document.createElement('option'); o1.value = String(l); o1.textContent = String(l); dSel.appendChild(o1);
            const o2 = document.createElement('option'); o2.value = String(l); o2.textContent = String(l); hSel.appendChild(o2);
        });
        if (labels.length){ dSel.value = String(labels[0]); hSel.value = String(labels[labels.length-1]); }
    } catch(e){ console.error('Error poblando rango Ejecutivo:', e); }
}

// Inicializar selects de rango al terminar initializeCharts
document.addEventListener('DOMContentLoaded', function(){
    try {
        // Se poblar√°n despu√©s de que initializeCharts cree los gr√°ficos y guarde _orig*
        setTimeout(function(){
            if (window._origCurvaS) populateCurvaSRango(window._origCurvaS.labels);
            if (window._origExec) populateExecRango(window._origExec.labels);
        }, 100);
    } catch(e){ console.error('Error inicializando filtros de periodo:', e); }
});
</script>
{% endblock %}